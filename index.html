<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KNM Quiz – Diagnostics</title>
<style>
  body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial;background:#0b0f1c;color:#e5e7eb}
  .wrap{max-width:900px;margin:16px auto;padding:12px}
  .card{background:#0f1628;border:1px solid #1f2b44;border-radius:10px;padding:12px;margin-top:10px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  label{font-weight:600;color:#9ca3af}
  input[type=radio]{margin-right:6px}
  input[type=text]{background:#0b1220;border:1px solid #243041;color:#e5e7eb;padding:10px;border-radius:8px;flex:1;font-size:18px}
  button{background:#22d3ee;color:#00242a;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .prompt{font-size:24px;font-weight:800;margin:8px 0}
  .feedback{min-height:22px;margin-top:8px}
  .ok{color:#22c55e;font-weight:700}
  .bad{color:#ef4444;font-weight:700}
  .small{font-size:12px;color:#9ca3af}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#0b1220;border:1px solid #22314a;color:#9ca3af;font-size:12px;margin-right:6px}
</style>
</head>
<body>
<div class="wrap">
  <h2>KNM Quiz – All Lessons (Diagnostics)</h2>

  <div class="card">
    <div id="diag" class="small">Loading data…</div>
    <div class="row" style="margin-top:6px">
      <div><label>Direction:</label>
        <label><input type="radio" name="dir" value="nl-en" checked> NL → EN</label>
        <label><input type="radio" name="dir" value="en-nl"> EN → NL</label>
      </div>
      <div><label><input type="checkbox" id="lenient" checked> Lenient check</label></div>
      <button id="testBtn" type="button">Test Data</button>
      <button id="startBtn" type="button" disabled>Start (All lessons)</button>
    </div>
  </div>

  <div class="card" id="quiz" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill" id="dirPill"></span>
        <span class="pill" id="countPill"></span>
      </div>
      <div class="small"><span id="score">0</span> correct • <span id="progress">0/0</span></div>
    </div>
    <div class="prompt" id="prompt"></div>
    <div class="row">
      <input id="answer" type="text" placeholder="Type your answer…" autocomplete="off" />
      <button id="checkBtn" type="button">Check</button>
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="small" id="meta"></div>
  </div>
</div>

<script>
(function(){
  // ======= EMBEDDED DATA (first few entries only for the diagnostic) =======
  // Replace this small sample with your full array later.
  const ALL = [
    {lesson:"Lesson 1", nl:"verschillende", en:"different"},
    {lesson:"Lesson 1", nl:"getrouwd", en:"married"},
    {lesson:"Lesson 1", nl:"de bruiloft", en:"wedding"}
  ];
  // ======= END DATA =======

  const diag = document.getElementById('diag');
  const startBtn = document.getElementById('startBtn');
  const testBtn = document.getElementById('testBtn');
  const dirRadios = [...document.querySelectorAll('input[name=dir]')];
  const lenientChk = document.getElementById('lenient');

  function getDir(){ return dirRadios.find(r=>r.checked).value; }

  // Show how many items we have
  const total = ALL.length;
  if (total > 0) {
    diag.textContent = "Items loaded: " + total;
    startBtn.disabled = false;
  } else {
    diag.textContent = "No items embedded (0). Start will stay disabled.";
  }

  // Simple normalize functions
  function normalize(s){ return (s||'').toLowerCase().replace(/[()\\[\\]{}]/g,'').replace(/\\s+/g,' ').trim(); }
  function stripArticles(s){ return s.replace(/^(de|het|the|a|an)\\s+/i,'').trim(); }
  function normalizeForCompare(s){ let t=normalize(s); if(lenientChk.checked) t=stripArticles(t); return t; }

  // For all-lessons queue
  let queue = [], idx = 0, score = 0, autoTimer = null;

  function splitVariants(s){
    let t=(s||'').replace(/\\n/g,' ').replace(/\\s{2,}/g,' ').replace(/\\((.*?)\\)/g,'').trim();
    const p=t.split(/\\s*[,;\\/\\|]\\s*/).map(x=>x.trim()).filter(Boolean);
    return p.length ? p : [t];
  }

  function buildAll(dir){
    const q=[];
    ALL.forEach(r=>{
      const nlV=splitVariants(r.nl), enV=splitVariants(r.en);
      const nlA=new Set(), enA=new Set();
      nlV.forEach(v=>{ nlA.add(v); nlA.add(stripArticles(v)); });
      enV.forEach(v=>{ enA.add(v); enA.add(stripArticles(v)); });
      if (dir==='nl-en') q.push({prompt:nlV[0], answers:[...enA], lesson:r.lesson});
      else q.push({prompt:enV[0], answers:[...nlA], lesson:r.lesson});
    });
    for(let i=q.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [q[i],q[j]]=[q[j],q[i]]; }
    return q;
  }

  // ---- UI wiring ----
  const quiz = document.getElementById('quiz');
  const dirPill = document.getElementById('dirPill');
  const countPill = document.getElementById('countPill');
  const scoreEl = document.getElementById('score');
  const progressEl = document.getElementById('progress');
  const promptEl = document.getElementById('prompt');
  const answerEl = document.getElementById('answer');
  const checkBtn = document.getElementById('checkBtn');
  const feedback = document.getElementById('feedback');
  const meta = document.getElementById('meta');

  function updateProgress(){
    progressEl.textContent = (idx+1) + "/" + queue.length;
    scoreEl.textContent = score;
  }

  function loadFill(){
    feedback.textContent='';
    if(idx>=queue.length){
      promptEl.textContent='Finished!';
      feedback.innerHTML = "<b>Score:</b> " + score + " / " + queue.length;
      answerEl.disabled=true; checkBtn.disabled=true;
      meta.textContent='';
      return;
    }
    const q=queue[idx];
    promptEl.textContent=q.prompt;
    answerEl.value=''; answerEl.disabled=false; checkBtn.disabled=false;
    answerEl.focus();
    meta.textContent = "Source: " + (q.lesson||'');
    updateProgress();
  }

  function isCorrect(user, answers){
    const u = normalizeForCompare(user);
    return answers.some(a=>normalizeForCompare(a)===u);
  }

  startBtn.addEventListener('click', ()=>{
    idx=0; score=0;
    const dir=getDir();
    queue = buildAll(dir);
    if(!queue.length){ diag.textContent='No items found.'; return; }
    dirPill.textContent = (dir==='nl-en' ? 'NL → EN' : 'EN → NL');
    countPill.textContent = 'Items: ' + queue.length;
    quiz.style.display='';
    loadFill();
  });

  checkBtn.addEventListener('click', ()=>{
    const q=queue[idx]; const ok=isCorrect(answerEl.value,q.answers);
    if(ok) score++;
    feedback.innerHTML = ok? '<span class="ok">Correct!</span>' : '<span class="bad">Wrong.</span> Correct: <b>'+q.answers[0]+'</b>';
    answerEl.disabled=true; checkBtn.disabled=true;
    clearTimeout(autoTimer);
    autoTimer = setTimeout(()=>{ idx++; loadFill(); }, 3000);
  });

  answerEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkBtn.click(); });

  // Test Data button to confirm handlers & data on your device
  testBtn.addEventListener('click', ()=>{
    if (ALL.length===0){ alert('No data embedded.'); return; }
    const first = ALL[0];
    alert('First pair:\\nNL: '+first.nl+'\\nEN: '+first.en+'\\n(Lesson: '+first.lesson+')');
  });
})();
</script>
</body>
</html>
